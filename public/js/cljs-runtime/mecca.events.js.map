{"version":3,"sources":["mecca/events.cljs"],"mappings":"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","names":["re_frame.core.reg_event_db","_","day8.re_frame.undo.undoable","p__26943","vec__26945","cljs.core.nth","db","time","pitch","cljs.core.update","note","p1__26942#","cljs.core.remove","cljs.core._EQ_","p__26948","vec__26949","beats-per-measure","p__26952","vec__26953","notes","cljs.core.assoc","p__26956","vec__26957","mecca.music/play-song!","cljs.core/deref","mecca.music/audiocontext","p__26960","vec__26961","p__26965","vec__26966","cljs.core/not","p__26969","vec__26970","p__26973","vec__26974","p__26978","vec__26979","p__26982","vec__26983","G__26986","re-frame.core/dispatch","p__26987","vec__26988","pos","p__26991","vec__26992","instrument","p__26995","vec__26996","p__27001","vec__27002","G__27005","re-frame.core/subscribe","beat","G__27006","to-play","p1__26999#","cljs.core.filter","G__27007","p1__27000#","p__27009","vec__27010","p1__27008#","p__27014","vec__27015","p1__27013#","p__27018","vec__27019","p__27023","vec__27024","p1__27022#","p__27027","vec__27028","p__27031","vec__27032","tempo","p__27036","vec__27037","p1__27035#","p__27041","vec__27042","p1__27040#","p__27047","vec__27048","key","p__27051","vec__27052","p__27055","vec__27056","x","p__27060","vec__27062","G__27065","seconds-per-beat","p1__27059#","cljs.core/inc","p__27069","vec__27070","G__27073","G__27074","p1__27068#","cljs.core/into","p__27075","vec__27076","mecca.music/play-sample","G__27084","cljs.core/conj","G__27085","p__27089","vec__27090","cljs.core.not_EQ_","G__27096","cljs.core.get","G__27097","p__27098","vec__27099"],"sourcesContent":["(ns ^:figwheel-hooks mecca.events\r\n  (:require\r\n   [re-frame.core :refer [reg-event-db reg-event-fx dispatch subscribe]]\r\n   [re-pressed.core :as rp]\r\n   [day8.re-frame.undo :as undo :refer [undoable]]\r\n   [mecca.mario :as mario :refer [mario]]\r\n   [mecca.music :as music :refer [audiocontext]]\r\n   [goog.events :refer [listen unlisten]])\r\n  (:import [goog.events EventType]))\r\n\r\n(reg-event-db\r\n :initialize-db\r\n (fn [_ _]\r\n   {:focused-note-pos [nil nil]\r\n    :eraser? false\r\n    :playing? false\r\n    :play-start 0\r\n    :jumping? false\r\n    :sharp? false\r\n    :repeat? false\r\n    :loop-end nil\r\n    :current-position 0\r\n    :current-note 0\r\n    :next-note-time 0.0\r\n    :notes-in-queue []\r\n    :editor-beat-start 1\r\n    :instrument 28\r\n    :array-buffer nil\r\n    :key \"C\"\r\n    :time 0\r\n    :time-signature 4\r\n    :tempo 220\r\n    :notes []\r\n    :lead []\r\n    :bassline []\r\n    :drums []\r\n    :mario-x 54\r\n    :mario-y 61\r\n    :mario-jump 0\r\n    :mario-run 1\r\n    :xml \"\"}))\r\n\r\n(reg-event-db\r\n :remove-note\r\n (undoable \"remove note\")\r\n (fn [db [_ time pitch]]\r\n   (update db :notes\r\n           (fn [note]\r\n             (remove #(and (= time (:time %))\r\n                           (= pitch (:pitch %)))\r\n                     note)))))\r\n\r\n(reg-event-db\r\n :set-time-signature\r\n (fn [db [_ beats-per-measure]]\r\n   (update db :time-signature beats-per-measure)))\r\n\r\n(reg-event-db\r\n :set-notes\r\n (fn [db [_ notes]]\r\n   (assoc db :notes notes)))\r\n\r\n(reg-event-db\r\n :play-on\r\n (fn [db [_ _]]\r\n   (music/play-song!)\r\n   (assoc\r\n    (assoc db :play-start (.-currentTime @audiocontext))\r\n    :playing? true)))\r\n\r\n(reg-event-db\r\n :sharp-on\r\n (fn [db [_ _]]\r\n   (assoc db :sharp? true)))\r\n\r\n(reg-event-db\r\n :sharp-toggle\r\n (fn [db [_ _]]\r\n   (update db :sharp? not)))\r\n\r\n(reg-event-db\r\n :eraser-toggle\r\n (fn [db [_ _]]\r\n   (update db :eraser? not)))\r\n\r\n(reg-event-db\r\n :sharp-off\r\n (fn [db [_ _]]\r\n   (assoc db :sharp? false)))\r\n\r\n(reg-event-db\r\n :pause\r\n (fn [db [_ _]]\r\n   (assoc db :playing? false)))\r\n\r\n(reg-event-db\r\n :stop\r\n (fn [db [_ _]]\r\n   (dispatch [:reset-editor])\r\n   (assoc\r\n    (assoc db :playing? false)\r\n    :current-position 0)))\r\n\r\n(reg-event-db\r\n :update-focus-note\r\n (fn [db [_ pos]]\r\n   (assoc db :focused-note-pos pos)))\r\n\r\n(reg-event-db\r\n :select-instrument\r\n (fn [db [_ instrument]]\r\n   (assoc db :instrument instrument)))\r\n\r\n(reg-event-db\r\n :play-off\r\n (fn [db [_ _]]\r\n   (assoc db :playing? false)))\r\n\r\n(reg-event-db\r\n :advance-position\r\n (fn [db [_ _]]\r\n   (let [notes (subscribe [:notes])\r\n         beat (subscribe [:current-position])\r\n         to-play (filter #(= (+ 1 @beat) (:time %)) @notes)]\r\n     (if (< 4 @beat)\r\n       (dispatch [:advance-editor]))\r\n     #_(doall (for [{:keys [instrument pitch]} to-play]\r\n                (music/play-sample instrument (if @(subscribe [:sharp?]) (+ 0.5 pitch) pitch))))\r\n     (update db :current-position #(+ 0.5 %)))))\r\n\r\n(reg-event-db\r\n :advance-editor\r\n (fn [db [_ _]]\r\n   (update db :editor-beat-start #(+ 0.5 %))))\r\n\r\n(reg-event-db\r\n :move-mario\r\n (fn [db [_ _]]\r\n   (update db :mario-x #(+ 10 %))))\r\n\r\n(reg-event-db\r\n :reset-editor\r\n (fn [db [_ _]]\r\n   (assoc db :editor-beat-start 1)))\r\n\r\n(reg-event-db\r\n :retract-editor\r\n (fn [db [_ _]]\r\n   (update db :editor-beat-start #(- % 0.5))))\r\n\r\n(reg-event-db\r\n :reset-position\r\n (fn [db [_ _]]\r\n   (assoc db :current-position 0)))\r\n\r\n(reg-event-db\r\n :set-tempo\r\n (fn [db [_ tempo]]\r\n   (assoc db :tempo tempo)))\r\n\r\n(reg-event-db\r\n :inc-tempo\r\n (fn [db [_ tempo]]\r\n   (update db :tempo #(+ 8 %))))\r\n\r\n(reg-event-db\r\n :dec-tempo\r\n (fn [db [_ tempo]]\r\n   (update db :tempo #(- % 8))))\r\n\r\n(reg-event-db\r\n :set-key\r\n (fn [db [_ key]]\r\n   (assoc db :key key)))\r\n\r\n(reg-event-db\r\n :repeat-toggle\r\n (fn [db [_ _]]\r\n   (update db :repeat? not)))\r\n\r\n(reg-event-db\r\n :set-loop-end\r\n (fn [db [_ x]]\r\n   (assoc db :loop-end x)))\r\n\r\n(reg-event-db\r\n :next-note\r\n (fn [db [_ _]]\r\n   (let [tempo (subscribe [:tempo])\r\n         seconds-per-beat (/ 60.0 @tempo)]\r\n     (update \r\n      (update db :current-note inc)\r\n      :next-note-time #(+ % seconds-per-beat)))))\r\n\r\n(reg-event-db\r\n :schedule-note\r\n (fn [db [_ _]]\r\n   (let [notes (subscribe [:notes])\r\n         beat (subscribe [:current-note])\r\n         to-play (filter #(= (+ 1 @beat) (:time %)) @notes)]\r\n     (update db :notes-in-queue\r\n             into to-play))))\r\n\r\n(reg-event-db\r\n :add-note\r\n (undoable \"add note\")\r\n (fn [db [_ instrument time pitch]]\r\n   (if (= (.-state @audiocontext) \"suspended\")\r\n     (.resume @audiocontext))\r\n   (music/play-sample instrument (if @(subscribe [:sharp?]) (inc pitch) pitch))\r\n   (update db :notes\r\n           conj \r\n           {:time time\r\n            :instrument instrument\r\n            :pitch (if @(subscribe [:sharp?])\r\n                    (inc pitch) pitch)})))\r\n\r\n\r\n(reg-event-db\r\n :tick!\r\n (fn [db [_ _]]\r\n   (if (not= 0 @(subscribe [:mario-jump]))\r\n     (assoc db :mario-y (- 61\r\n                  (get [5 10 15 20 24 27 29 30\r\n                        30 29 27 24 20 15 10 5]\r\n                       @(subscribe [:mario-jump])))))))\r\n\r\n(reg-event-db\r\n :play-note\r\n (fn [db [_ pitch]]\r\n   (assoc db :notes-in-queue [{:pitch pitch\r\n                               :time  0}])))\r\n\r\n"]}